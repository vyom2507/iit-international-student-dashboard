// prisma/schema.prisma

// Generates the Prisma Client for use in lib/prisma.ts
generator client {
  provider = "prisma-client-js"
}

// Neon Postgres datasource
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * =========================
 * STUDENTS & AUTH
 * =======================
 */

model Student {
  id          String   @id @default(cuid())
  fullName    String
  email       String   @unique
  password    String // hashed password
  studentType String // e.g. "undergrad" | "grad" | "phd" | "coursera"
  program     String
  avatarUrl   String?
  isAdmin     Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // ðŸ”´ Chat relations (dashboard real-time chat)
  messages         ChatMessage[]
  pinnedRooms      StudentPinnedRoom[]
  lastActiveRoomId String?
  lastActiveRoom   ChatRoom?           @relation("LastActiveRoom", fields: [lastActiveRoomId], references: [id])

  // ðŸ”´ Marketplace relations
  listings Product[] @relation("StudentListings") // items this student is selling
  orders   Order[]   @relation("StudentOrders") // items this student has bought

  // ðŸ”´ Marketplace conversations (buyer/seller)
  buyerConversations  MarketplaceConversation[] @relation("MarketplaceBuyer")
  sellerConversations MarketplaceConversation[] @relation("MarketplaceSeller")

  // ðŸ”´ Marketplace chat messages (individual messages)
  marketplaceMessages MarketplaceMessage[] @relation("MarketplaceMessages")

  // ðŸ”´ Admin
  announcements Announcement[] @relation("AnnouncementAuthor")
}

/**
 * =========================
 * CHAT ROOMS (GROUP CHAT)
 * =======================
 */

model ChatRoom {
  id          String        @id @default(cuid())
  slug        String        @unique
  name        String
  description String?
  messages    ChatMessage[]
  createdAt   DateTime      @default(now())

  pinnedBy      StudentPinnedRoom[]
  lastActiveFor Student[]           @relation("LastActiveRoom")
}

model ChatMessage {
  id     String   @id @default(cuid())
  roomId String
  room   ChatRoom @relation(fields: [roomId], references: [id])

  studentId String
  student   Student @relation(fields: [studentId], references: [id])

  content   String
  createdAt DateTime @default(now())

  @@index([roomId, createdAt])
}

model StudentPinnedRoom {
  studentId String
  roomId    String

  student   Student  @relation(fields: [studentId], references: [id])
  room      ChatRoom @relation(fields: [roomId], references: [id])
  createdAt DateTime @default(now())

  @@id([studentId, roomId])
}

/**
 * =========================
 * ANNOUNCEMENTS (ADMIN)
 * =======================
 */

model Announcement {
  id          String   @id @default(cuid())
  title       String
  body        String
  createdAt   DateTime @default(now())
  createdById String
  createdBy   Student  @relation("AnnouncementAuthor", fields: [createdById], references: [id])
}

/**
 * =========================
 * MARKETPLACE
 * =======================
 */

model Product {
  id          String @id @default(cuid())
  title       String
  slug        String @unique
  description String
  priceCents  Int
  category    String
  condition   String // e.g. "Like New", "Good"
  imageUrl    String
  campus      String // e.g. "Mies Campus"

  // ðŸ”¹ Ownership (optional so existing rows donâ€™t break)
  ownerId String?
  owner   Student? @relation("StudentListings", fields: [ownerId], references: [id])

  // ðŸ”¹ Availability
  isActive Boolean   @default(true)
  soldAt   DateTime?

  // ðŸ”¹ Listing preferences (comma-separated: "card,in_person")
  paymentOptions String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]
}

model Order {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id])

  buyerId String
  buyer   Student @relation("StudentOrders", fields: [buyerId], references: [id])

  paymentMethod String // "card" | "in_person"
  status        String @default("created") // "created" | "paid" | "cancelled"

  stripeSessionId String? @unique

  createdAt DateTime @default(now())

  conversations MarketplaceConversation[]
}

model MarketplaceConversation {
  id      String @id @default(cuid())
  orderId String @unique
  order   Order  @relation(fields: [orderId], references: [id])

  buyerId String
  buyer   Student @relation("MarketplaceBuyer", fields: [buyerId], references: [id])

  sellerId String
  seller   Student @relation("MarketplaceSeller", fields: [sellerId], references: [id])

  messages MarketplaceMessage[]

  createdAt DateTime @default(now())
}

model MarketplaceMessage {
  id             String                  @id @default(cuid())
  conversationId String
  conversation   MarketplaceConversation @relation(fields: [conversationId], references: [id])

  senderId String
  sender   Student @relation("MarketplaceMessages", fields: [senderId], references: [id])

  content   String
  createdAt DateTime @default(now())
}
